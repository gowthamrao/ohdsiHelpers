#' @export
executeCohortExplorerInParallel <-
  function(cdmSources,
           outputFolder,
           cohortDefinitionSet,
           cohortTableNames = CohortGenerator::getCohortTableNames(cohortTable = "cohort"),
           userService = "OHDSI_USER",
           passwordService = "OHDSI_PASSWORD",
           tempEmulationSchema = getOption("sqlRenderTempEmulationSchema"),
           databaseIds = getListOfDatabaseIds(),
           sequence = 1,
           sampleSize = 100,
           cohortIds = NULL) {

    cdmSources <-
      getCdmSource(cdmSources = cdmSources,
                   database = databaseIds,
                   sequence = sequence)

    x <- list()
    for (i in 1:nrow(cdmSources)) {
      x[[i]] <- cdmSources[i, ]
    }

    # use Parallel Logger to run in parallel
    cluster <-
      ParallelLogger::makeCluster(numberOfThreads = min(
        as.integer(trunc(
          parallel::detectCores() /
            2
        )),
        length(x)
      ))

    ## file logger
    loggerName <-
      paste0(
        "CE_",
        stringr::str_replace_all(
          string = Sys.time(),
          pattern = ":|-|EDT| ",
          replacement = ""
        )
      )

    ParallelLogger::addDefaultFileLogger(fileName = file.path(outputFolder, paste0(loggerName, ".txt")))

    executeCohortExplorerX <- function(x,
                                       cohortDefinitionSet,
                                       cohortIds,
                                       cohortTableNames,
                                       outputFolder,
                                       sampleSize,
                                       tempEmulationSchema) {
      connectionDetails <- createConnectionDetails(cdmSources = x, database = x$database)

      featureCohortDefinitionSet <- cohortDefinitionSet

      if (!is.null(cohortIds)) {
        cohortDefinitionSet <- cohortDefinitionSet |>
          dplyr::filter(.data$cohortId %in% cohortIds)
      }

      for (i in (1:nrow(cohortDefinitionSet))) {
        CohortExplorer::createCohortExplorerApp(
          cohortDefinitionId = cohortDefinitionSet[i, ]$cohortId,
          cohortName = cohortDefinitionSet[i, ]$cohortName,
          exportFolder = outputFolder,
          databaseId = SqlRender::snakeCaseToCamelCase(x$sourceKey),
          cohortDatabaseSchema = x$cohortDatabaseSchemaFinal,
          connectionDetails = connectionDetails,
          connection = NULL,
          cdmDatabaseSchema = x$cdmDatabaseSchemaFinal,
          vocabularyDatabaseSchema = x$vocabDatabaseSchemaFinal,
          tempEmulationSchema = tempEmulationSchema,
          cohortTable = cohortTableNames$cohortTable,
          featureCohortDatabaseSchema = x$cohortDatabaseSchemaFinal,
          featureCohortTable = cohortTableNames$cohortTable,
          sampleSize = sampleSize,
          featureCohortDefinitionSet = featureCohortDefinitionSet
        )
      }
    }

    ParallelLogger::clusterApply(
      cluster = cluster,
      x = x,
      cohortDefinitionSet = cohortDefinitionSet,
      cohortIds = cohortIds,
      outputFolder = outputFolder,
      cohortTableNames = cohortTableNames,
      sampleSize = sampleSize,
      tempEmulationSchema = tempEmulationSchema,
      fun = executeCohortExplorerX,
      stopOnError = FALSE
    )

    ParallelLogger::stopCluster(cluster = cluster)
  }
